# 並行作業リファクタリング計画 - 松江市温泉マップ

## 📅 計画策定日: 2025 年 6 月 6 日

## 🎯 並行作業の基本方針

1. **依存関係のない作業を同時並行**で実行
2. **ファイル競合を避ける**ための作業範囲分離
3. **テスト実行**による品質確認を各作業後に実施
4. **段階的進行**で動作確認しながら安全に進める

---

## 🚀 今週の並行作業計画（6 月 6 日〜12 日）

### 📊 作業分類と並行実行可能性

| 作業分類              | ファイル影響範囲                 | 並行実行 | 優先度 |
| --------------------- | -------------------------------- | -------- | ------ |
| **A. モデル改善**     | `app/models/`                    | ✅ 可能  | 🔴 高  |
| **B. ビュー改善**     | `app/views/`                     | ✅ 可能  | 🔴 高  |
| **C. フロントエンド** | `app/javascript/`, `app/assets/` | ✅ 可能  | 🟡 中  |
| **D. テスト強化**     | `spec/`                          | ✅ 可能  | 🟡 中  |
| **E. 設定最適化**     | `config/`, `docker/`             | ⚠️ 慎重  | 🟢 低  |

---

## 📋 作業ブロック詳細

### 🅰️ **ブロック A: モデル層改善** (並行作業 1)

**担当範囲**: `app/models/`, `app/services/`
**推定時間**: 3-4 時間
**依存関係**: なし

#### A1. Onsen モデルの責務分離 (1.5 時間)

- [ ] `Onsen.search`メソッドを scope に分割
  - [ ] `scope :by_text_search, ->(query)`
  - [ ] `scope :by_tag_search, ->(tags)`
  - [ ] `scope :by_location_search, ->(params)`
- [ ] バリデーションロジックの整理とコメント強化
- [ ] 平均評価計算の最適化

#### A2. Review モデルの機能拡張 (1 時間)

- [ ] レビューの並び順 scope 追加
- [ ] 評価統計メソッドの追加
- [ ] バリデーションメッセージの日本語化

#### A3. サービス層の責務分離 (1.5 時間)

- [ ] `MapService`を以下に分割:
  - [ ] `DistanceCalculator` (距離計算専用)
  - [ ] `AddressResolver` (住所 → 座標変換)
  - [ ] `GeocodingService` (外部 API 連携)
- [ ] エラーハンドリングの統一

---

### 🅱️ **ブロック B: ビュー・UI 改善** (並行作業 2)

**担当範囲**: `app/views/`, `app/helpers/`
**推定時間**: 3-4 時間
**依存関係**: なし

#### B1. パーシャル分割・整理 (2 時間)

- [ ] 大きなビューファイルの分割
  - [ ] `admin/onsens/index.html.erb` → 複数パーシャル
  - [ ] `onsens/show.html.erb` → レビュー部分分離
- [ ] 共通パーシャルの抽出
  - [ ] `shared/_onsen_card.html.erb`
  - [ ] `shared/_review_card.html.erb`

#### B2. アクセシビリティ改善 (1 時間)

- [ ] ARIA 属性の追加
- [ ] alt 属性の統一
- [ ] キーボードナビゲーション対応

#### B3. レスポンシブ対応強化 (1 時間)

- [ ] モバイルファーストの見直し
- [ ] Tailwind クラスの整理
- [ ] 画像表示の最適化

---

### 🅲️ **ブロック C: フロントエンド改善** (並行作業 3)

**担当範囲**: `app/javascript/`, `app/assets/`
**推定時間**: 2-3 時間
**依存関係**: なし

#### C1. Stimulus コントローラ改善 (1.5 時間)

- [ ] 各コントローラのコメント強化
- [ ] エラーハンドリングの統一
- [ ] デバッグ機能の追加

#### C2. Hotwire 機能拡張 (1 時間)

- [ ] Turbo Frames の導入検討
- [ ] リアルタイム更新の改善
- [ ] ページ遷移の最適化

#### C3. アセット最適化 (0.5 時間)

- [ ] 不要 CSS の削除
- [ ] 画像圧縮の自動化検討

---

### 🅳️ **ブロック D: テスト強化** (並行作業 4)

**担当範囲**: `spec/`, テストファイル
**推定時間**: 2-3 時間
**依存関係**: モデル改善後に一部依存

#### D1. モデルテスト強化 (1 時間)

- [ ] Onsen モデルの新しい scope テスト
- [ ] Review モデルのバリデーションテスト
- [ ] 関連性テストの追加

#### D2. コントローラテスト追加 (1 時間)

- [ ] エラーケースのテスト
- [ ] レスポンス形式のテスト
- [ ] Strong Parameters テスト

#### D3. 統合テスト (System Spec) (1 時間)

- [ ] ユーザーフローテスト
- [ ] JavaScript 有効時のテスト
- [ ] レスポンシブ対応テスト

---

## ⏰ 週間スケジュール

### 【6 月 6 日 (木)】

- **午前 (9:00-12:00)**: ブロック A1 + ブロック B1 (並行)
- **午後 (13:00-16:00)**: ブロック A2 + ブロック C1 (並行)
- **夕方 (16:00-17:00)**: 動作確認・テスト実行

### 【6 月 7 日 (金)】

- **午前 (9:00-12:00)**: ブロック A3 + ブロック B2 (並行)
- **午後 (13:00-16:00)**: ブロック B3 + ブロック C2 (並行)
- **夕方 (16:00-17:00)**: 週間進捗レビュー

### 【6 月 8 日 (土)】

- **午前 (9:00-12:00)**: ブロック D1 + ブロック C3 (並行)
- **午後 (13:00-15:00)**: ブロック D2 + D3 (順次)
- **夕方 (15:00-16:00)**: 全体テスト・統合確認

---

## 🔧 作業実行ガイドライン

### 並行作業時の注意事項

1. **ファイル競合回避**: 同じファイルを複数人で編集しない
2. **定期コミット**: 30 分〜1 時間ごとに小さなコミット
3. **テスト実行**: 各ブロック完了後に必ずテスト実行
4. **進捗共有**: Slack またはコメントで進捗を報告

### ブランチ戦略

```bash
# 各ブロック用のフィーチャーブランチを作成
git checkout -b refactor/block-a-model-improvements
git checkout -b refactor/block-b-view-improvements
git checkout -b refactor/block-c-frontend-improvements
git checkout -b refactor/block-d-test-enhancements
```

### テスト実行コマンド

```bash
# 各ブロック完了後の確認コマンド
docker compose run --rm web bundle exec rspec
docker compose run --rm web bundle exec rails assets:precompile
docker compose up # 動作確認
```

---

## 📈 進捗管理

### 完了基準

- [ ] **機能テスト**: 該当機能が正常動作
- [ ] **コードレビュー**: 可読性・保守性の向上確認
- [ ] **テストカバレッジ**: 新機能に対するテスト追加
- [ ] **ドキュメント更新**: 変更内容の文書化

### 日次チェックポイント

- **朝 9:00**: 当日の作業ブロック確認
- **昼 12:00**: 午前の進捗確認・課題共有
- **夕方 17:00**: 当日の完了タスク確認・翌日計画

### 週次レビュー (金曜 17:00)

- 完了したブロックの品質確認
- 残課題の整理と翌週への引き継ぎ
- 計画の見直しと調整

---

## 🚨 リスク管理

### 高リスク項目と対策

1. **ファイル競合**: ブランチ分離で回避
2. **テスト失敗**: 小さな変更での段階的確認
3. **Docker 環境エラー**: 作業前の環境確認
4. **API 依存エラー**: モックを使った開発

### 緊急時対応

- **作業ブロック**: 問題発生時は他ブロックに切り替え
- **ロールバック**: git revert で即座に元に戻す
- **サポート**: チーム内での相互フォロー体制

---

## 🎯 成果目標

### 週末までの達成目標

- [ ] **モデル責務分離**: 検索機能の可読性向上
- [ ] **ビュー整理**: 再利用可能なコンポーネント化
- [ ] **フロントエンド改善**: Stimulus/Hotwire 活用強化
- [ ] **テストカバレッジ**: 90%以上を目標
- [ ] **学習効果**: 初学者向けコメント充実

### 定量指標

- **コード行数削減**: 各ファイル平均 20%削減
- **メソッド複雑度**: Cyclomatic Complexity < 10
- **テストカバレッジ**: 90%以上
- **ドキュメント充実度**: 全 public method に YARD 記法適用

---

_策定日: 2025 年 6 月 6 日_
_更新予定: 毎日 17:00_
_次回大幅見直し: 2025 年 6 月 13 日_
