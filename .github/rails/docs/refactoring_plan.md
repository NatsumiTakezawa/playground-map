# 松江市温泉マップ - 初学者向けリファクタリング計画書（テスト除外版）

## 目的

現在の Rails + Hotwire + Tailwind 実装を、**初学者が理解しやすい教材**にリファクタリングする。
コードの可読性、学習効率、保守性を向上させることを最優先とする。
**テスト実装は除外し、コードの理解しやすさに集中する。**

## 全体スケジュール

- **期間**: 2025 年 6 月〜7 月（約 2 ヶ月）
- **方針**: 段階的リファクタリング（動作確認しながら進める）
- **目標**: 初学者がステップバイステップで学習できる教材完成

---

## 優先順位付けマトリクス

| 優先度   | 分類       | 影響度 | 実装難易度 | 学習効果 |
| -------- | ---------- | ------ | ---------- | -------- |
| **最高** | 基盤整備   | 高     | 低         | 高       |
| **高**   | コード品質 | 高     | 中         | 高       |
| **中**   | 機能強化   | 中     | 中         | 中       |
| **低**   | 最適化     | 低     | 高         | 低       |

---

## フェーズ 1：基盤整備（最優先）✅

### 1.1 ドキュメント・コメントの統一化

- **目標**: 初学者が理解しやすい日本語ドキュメント
- **期間**: 1 週間
- **状況**: 🔄 進行中

#### タスク（ドキュメント・コメント統一）

- [ ] 全ファイルのコメントを日本語に統一
- [ ] YARD 記法でメソッド・クラスの説明を詳細化
- [ ] README に初学者向け学習ガイド追加
- [ ] 実装ガイドラインの更新

### 1.2 日本語メッセージの統一化

- **目標**: ハードコードされた文字列を整理し、一貫した日本語表示を実現
- **期間**: 1 日
- **状況**: ⏳ 未着手

#### タスク（日本語メッセージ統一）

- [ ] ハードコードされた日本語文字列の整理
- [ ] バリデーションメッセージの日本語統一
- [ ] フラッシュメッセージの統一化
- [ ] 既存の ja.yml ファイルの活用・整理

### 1.3 設定・環境の整理

- **目標**: 初学者にとって設定が理解しやすい状態
- **期間**: 2 日
- **状況**: ⏳ 未着手

#### タスク（設定・環境）

- [ ] 環境変数の使い分けを明確化
- [ ] Docker 設定の最適化
- [ ] 開発環境セットアップ手順の詳細化

---

## フェーズ 2：コード品質向上（高優先）

### 2.1 コントローラのリファクタリング ✅

- **目標**: 1 メソッド 15 行以内、責務の明確化
- **期間**: 1 週間
- **状況**: ✅ 完了

#### タスク（コントローラリファクタリング）

- ✅ `Admin::OnsensController`の分割（CSV インポート分離）
- ✅ エラーハンドリングの共通化
- ✅ Strong Parameters の詳細コメント追加
- ✅ アクションメソッドのサイズ縮小

### 2.2 モデルの改善

- **目標**: 単一責任原則の徹底、わかりやすいメソッド名
- **期間**: 3 日
- **状況**: 🔄 並行作業計画により進行中

#### タスク（モデル改善）

- 🔄 `Onsen.search`メソッドの分割（scope メソッド化）
- 🔄 バリデーションロジックの整理
- 🔄 モデル間の関連付けを明確化
- 🔄 コールバックの目的を明記

### 2.3 サービス層の設計改善

- **目標**: 責務別クラス分離、保守性向上
- **期間**: 3 日
- **状況**: 🔄 並行作業計画により進行中

#### タスク（サービス層設計）

- 🔄 `MapService`を責務別に分離（`DistanceCalculator`, `AddressService`, `GeocodingService`）
- 🔄 `CsvImportService`のエラーハンドリング強化
- 🔄 サービス層の命名規則統一
- 🔄 各サービスのインターフェース明確化

---

## 📊 並行作業戦略（6 月 6 日〜実装中）

**新アプローチ**: 依存関係のない作業を 3 ブロックで同時並行実行

- **期間**: 2 日間集中実装
- **体制**: 単一開発者での効率的な作業ブロック分散

### 作業ブロック構成

#### **ブロック A**: モデル・サービス層改善

- Onsen.search メソッドの分割
- Review モデルの拡張
- サービス層の責務分離

#### **ブロック B**: ビュー・UI 改善

- パーシャルファイルの分割
- アクセシビリティ向上
- レスポンシブデザイン強化

#### **ブロック C**: フロントエンド改善

- Stimulus コントローラの改善
- Hotwire/Turbo 最適化
- アセット最適化

---

## フェーズ 3：フロントエンド改善（中優先）

### 3.1 Stimulus コントローラの改善

- **目標**: 初学者向けの段階的学習サポート
- **期間**: 3 日
- **状況**: 🔄 並行作業計画により進行中

#### タスク（Stimulus コントローラ）

- 🔄 各 Stimulus コントローラにステップバイステップコメント追加
- 🔄 複雑な JS 処理の分割・簡略化
- 🔄 エラーハンドリングの統一
- 🔄 イベント処理の明確化

### 3.2 ビュー・スタイルの整理

- **目標**: 再利用可能なコンポーネント設計
- **期間**: 3 日
- **状況**: 🔄 並行作業計画により進行中

#### タスク（ビュー・スタイルの整理）

- 🔄 大きなビューファイルをパーシャルに分割
- 🔄 Tailwind CSS 重複スタイルの共通化
- 🔄 アクセシビリティ改善（ARIA 属性追加）
- 🔄 レスポンシブ対応の向上

### 3.3 Hotwire・Turbo 活用の最適化

- **目標**: 初学者向け Hotwire 学習例の充実
- **期間**: 2 日
- **状況**: 🔄 並行作業計画により進行中

#### タスク（Hotwire・Turbo 最適化）

- 🔄 Turbo Streams の使用例を増加
- 🔄 Turbo Frames の導入検討
- 🔄 リアルタイム更新機能の改善
- 🔄 ページ遷移の最適化

---

## フェーズ 4：コード品質・保守性（中優先）

### 4.1 コード品質チェック強化

- **目標**: 自動化されたコード品質チェック
- **期間**: 1 日
- **状況**: ⏳ 並行作業後に実施予定

#### タスク（コード品質チェック強化）

- [ ] RuboCop 設定の最適化
- [ ] Brakeman（セキュリティチェック）の導入
- [ ] コードメトリクス測定（Flog, Flay 等）
- [ ] コードレビューチェックリストの作成

### 4.2 ファイル構成・名前空間の整理

- **目標**: ファイル配置とクラス構成の最適化
- **期間**: 2 日
- **状況**: ⏳ 未着手

#### タスク（ファイル構成整理）

- [ ] 関連ファイルのグルーピング最適化
- [ ] 名前空間の整理（Admin モジュールなど）
- [ ] 不要ファイル・ディレクトリの削除
- [ ] Rails 規約に沿ったファイル配置の確認

---

## 進捗管理ルール

### 状況マーク

- ⏳ **未着手**: まだ開始していない
- 🔄 **進行中**: 作業中
- ✅ **完了**: 作業完了・動作確認済み
- ⚠️ **保留**: 依存関係等で一時停止
- ❌ **中止**: 方針変更により中止

### 完了基準

1. **機能確認**: 該当機能が正常動作すること
2. **コードレビュー**: チェックリストに基づく品質確認
3. **ドキュメント更新**: 変更内容の文書化
4. **学習効果確認**: 初学者の理解度向上に寄与すること

### 週次レビュー

毎週金曜日に進捗レビューを実施

- 完了タスクの確認
- 課題・障害の洗い出し
- 次週計画の調整

---

## リスク管理

### 高リスク項目

1. **大幅な設計変更**: 既存機能への影響
2. **外部 API 依存**: Google Maps API 等の変更
3. **Docker 環境**: 開発環境の複雑化

### 対策

1. **段階的リファクタリング**: 小さな変更を積み重ね
2. **手動確認**: 各変更後の動作確認を徹底
3. **ブランチ戦略**: フィーチャーブランチでの開発
4. **ロールバック計画**: 問題発生時の復旧手順

---

## 学習効果測定

### 定量指標

- **コード行数**: メソッド・クラスあたりの行数
- **循環的複雑度**: 複雑性の数値化
- **ドキュメント充実度**: コメント・説明の量
- **ファイル数**: 適切な分割によるファイル数

### 定性指標

- **可読性**: 初学者による理解のしやすさ
- **保守性**: 機能追加・修正の容易さ
- **学習効率**: ステップバイステップ学習の実現

---

## 次のアクション

### 今週のタスク（6 月 7 日〜13 日）

1. ✅ テスト除外版リファクタリング計画書作成
2. 🔄 **ブロック A**: モデル層改善 (Onsen.search 分割、サービス分離)
3. 🔄 **ブロック B**: ビュー・UI 改善 (パーシャル分割、アクセシビリティ)
4. 🔄 **ブロック C**: フロントエンド改善 (Stimulus、Hotwire 最適化)

### 並行作業スケジュール

#### 【6 月 7 日 (金)】

- **午前**: ブロック A1 (Onsen.search 分割) + ブロック B1 (パーシャル分割)
- **午後**: ブロック A2 (Review 拡張) + ブロック C1 (Stimulus 改善)
- **夕方**: 動作確認・週間進捗レビュー

#### 【6 月 8 日 (土)】

- **午前**: ブロック A3 (サービス分離) + ブロック B2 (アクセシビリティ)
- **午後**: ブロック B3 (レスポンシブ) + ブロック C2 (Hotwire 拡張)
- **夕方**: 全体統合確認

### 来週の予定（6 月 14 日〜）

1. フェーズ 4 コード品質チェック強化の実装開始
2. RuboCop、Brakeman 導入
3. ファイル構成・名前空間の整理
4. フェーズ 5 学習サポート機能の検討

---

_最終更新: 2025 年 6 月 7 日_
_次回更新予定: 2025 年 6 月 8 日_
